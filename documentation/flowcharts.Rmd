---
title "Exploring Flowcharts using DiagrammeR - ver1.j"
author: "Rebecca Handcock"
date: "2023-12-14"
output: html_document
---

```{r message=TRUE, paged.print=TRUE}
#------------------------------------------------|
# Set BigQuery files
# This would ideally be done programatically, but for now is hard-coded
#------------------------------------------------|

# Academic Observatory - this is the version of the Academic Observatory
AcademicObservatory_table <- "academic-observatory.observatory.doi20231210"
AcademicObservatory_var1 <- "doi"

# ----------------------------------------------------------------------

# Contributed DATA: pubs - List of pubs/DOI of interest in the project
Contributed_pubs_raw <- "TheNeuro_dois_2010-2022.csv"
Contributed_pubs_table <- "university-of-ottawa.neuro_data_raw.raw20230217_theneuro_dois_20102022_tidy_long"
Contributed_pubs_var1 <- "doi"

# Contributed DATA: Oddpub - Output from the Oddpub processing
Contributed_Oddpub_raw <- "NEURO_oddpub_screening.csv"
Contributed_Oddpub_table <- "university-of-ottawa.neuro_data_raw.raw20230217_theneuro_oddpub_screening_tidy"
Contributed_Oddpub_var1 <- "doi"

# Contributed DATA: trials - List of actual clinical trials for the institution
Contributed_trials_raw <- "combined-ctgov-studies.csv"
Contributed_trials_table <- "university-of-ottawa.neuro_data_raw.montreal_neuro-studies_ver2_raw"
Contributed_trials_var1 <- "nct_id"

# Contributed DATA: ORCID - List of ORCIDs for researchers for the institution
Contributed_orcid_raw <- "neuro_pis_orcid.csv"
Contributed_orcid_table <- "university-of-ottawa.neuro_data_raw.neuro_pis_orcid"
Contributed_orcid_var1 <- "orcid_id"

# ----------------------------------------------------------------------
# Note, processing Step #1 only produces an intermediate table, so is not 
# included in the dashbaord output tables

# Output dashboard data - from the SQL - Step 2 - Clinical Trial data for institution
Dashboard_trials_table <- "university-of-ottawa.neuro_dashboard_data.dashboard_data_trials"
Dashboard_trials_var1 <- "nct_id"

# Output dashboard data - from the SQL - Step 3 - Pubs
Dashboard_pubs_table <- "university-of-ottawa.neuro_dashboard_data.dashboard_data_pubs"
Dashboard_pubs_var1 <- "doi"

# Output dashboard data - from the SQL - Step 4 - ORCID for researchers
Dashboard_orcid_table <- "university-of-ottawa.neuro_dashboard_data.dashboard_data_orcid"
Dashboard_orcid_var1 <- "orcid_id"

# ----------------------------------------------------------------------

```

```{r warning=FALSE, message=FALSE, include=FALSE}
#------------------------------------------------|
# setup packages
#------------------------------------------------|

# Github: https://github.com/rich-iannone/DiagrammeR
# Functions: https://rich-iannone.github.io/DiagrammeR/reference/index.html
# Package: https://cran.r-project.org/web/packages/DiagrammeR/DiagrammeR.pdf
# Tutorial: https://epirhandbook.com/en/diagrams-and-charts.html
# Reference; https://graphviz.org/pdf/dotguide.pdf
# Turotial: https://builtin.com/data-science/diagrammer

# DiagrammeR is a package within htmlwidgets for R. It is used to generate graphs using graphviz and mermaid library.
#install.packages("DiagrammeR")
library(DiagrammeR)

# rsvg: Renders vector-based svg images into images
library(rsvg)

# Connect to Bigquery
library(bigrquery)
library(DBI)

# helpful libraries
library(stringr)
library(dplyr)
library(purrr)

```


```{r message=FALSE, warning=FALSE}
#------------------------------------------------|
# FUNCTION F_bigquery_sql_count_distinct 
#------------------------------------------------|

F_bigquery_sql_count_distinct <- function(F_table, F_variable){
  
  # Set up query generics
  # SELECT COUNT(DISTINCT published_year) AS count_dist_x FROM `university-of-ottawa.neuro_dashboard_data.dashboard_data_pubs`
  sql_prefix <- "SELECT COUNT(DISTINCT "
  sql_middle <- ") FROM `"
  sql_end <- "`"

  sql <- paste(sql_prefix, F_variable, sql_middle,  F_table, sql_end, sep = "")

  # send the SQL to bigquery
  F_count <- dbGetQuery(con, sql)
  return(F_count)
  }
```


```{r FUNCTION: F_export_grViz_graph2image, message=FALSE, warning=FALSE}
#------------------------------------------------|
# FUNCTION export grViz graph to an image file
#------------------------------------------------|

F_export_grViz_graph2image <- function(graph2plot){
  # 1. Process the graph
  tmp = DiagrammeR::grViz(graph2plot)

  # 2. Convert to SVG, then save as png
  tmp = DiagrammeRsvg::export_svg(tmp)
  tmp = charToRaw(tmp) # flatten
  filename <- paste(deparse(substitute(graph2plot)), ".png", sep = "")
  print(filename)
  rsvg::rsvg_png(tmp, filename) # saved graph as png in current working directory
  }
```


```{r Connect to BigQuery database}
#------------------------------------------------|
# Connect to BigQuery database
#------------------------------------------------|

# --- To query BigQuery data with R and BigQuery, you first need to set up a connection to a data set using this syntax:
# con <- dbConnect(
#   bigquery(),
#   project = "university-of-ottawa",
#   dataset = "neuro_dashboard_data",
#   billing = "university-of-ottawa"
# )

con <- dbConnect(
  bigquery(),
  project = "university-of-ottawa",
  dataset = "neuro_dashboard_data",
  billing = "university-of-ottawa"
)
# Now run a simple query to prompt authenticating your Google account

dbListTables(con)

```


```{r Process Bigquery files, message=TRUE, messages=TRUE, paged.print=TRUE}
#------------------------------------------------|
# Fetch information about BigQuery datasets
# These values will be displayed later in the flowchart
#------------------------------------------------|

# Contributed DATA: pubs - List of pubs/DOI of interest in the project
Contributed_pubs_table_short <- str_split(Contributed_pubs_table, "\\.")[[1]][3]
Contributed_pubs_count1 <- F_bigquery_sql_count_distinct(Contributed_pubs_table, Contributed_pubs_var1)
Contributed_pubs_count1 <- Contributed_pubs_count1$f0_
print(paste("Contributed pubs (Target DOIs):",Contributed_pubs_table, "has", Contributed_pubs_count1,"distinct values for",Contributed_pubs_var1))
Dashboard_pubs_table_short <- str_split(Dashboard_pubs_table, "\\.")[[1]][3]

# Contributed DATA: Oddpub - Output from the Oddpub processing
Contributed_Oddpub_table_short <- str_split(Contributed_Oddpub_table, "\\.")[[1]][3]
Contributed_Oddpub_count1 <- F_bigquery_sql_count_distinct(Contributed_Oddpub_table, Contributed_Oddpub_var1)
Contributed_Oddpub_count1 <- Contributed_Oddpub_count1$f0_
print(paste("Contributed ODDPUB:", Contributed_Oddpub_table, "has", Contributed_Oddpub_count1,"distinct values for",Contributed_Oddpub_var1))

# Contributed DATA: trials - List of actual clinical trials for the institution
Contributed_trials_table_short <- str_split(Contributed_trials_table, "\\.")[[1]][3]
Contributed_trials_count1 <- F_bigquery_sql_count_distinct(Contributed_trials_table, Contributed_trials_var1)
Contributed_trials_count1 <- Contributed_trials_count1$f0_
print(paste("Contributed TRIALS:", Contributed_trials_table, "has", Contributed_trials_count1,"distinct values for",Contributed_trials_var1))
Dashboard_trials_table_short <- str_split(Dashboard_trials_table, "\\.")[[1]][3]

# Contributed DATA: ORCID - List of ORCIDs for researchers for the institution
Contributed_orcid_table_short <- str_split(Contributed_orcid_table, "\\.")[[1]][3]
Contributed_orcid_count1 <- F_bigquery_sql_count_distinct(Contributed_orcid_table, Contributed_orcid_var1)
Contributed_orcid_count1 <- Contributed_orcid_count1$f0_
print(paste("Contributed ODDPUB:", Contributed_orcid_table, "has", Contributed_orcid_count1,"distinct values for",Contributed_orcid_var1))
Dashboard_orcid_table_short <- str_split(Dashboard_orcid_table, "\\.")[[1]][3]
Dashboard_orcid_count1 <- F_bigquery_sql_count_distinct(Dashboard_orcid_table, Dashboard_orcid_var1)

#----------------------------------------------------------------------

# Output dashboard data - from the SQL - Step 2 - Clinical Trial data for institution
Dashboard_trials_table_short <- str_split(Dashboard_trials_table, "\\.")[[1]][3]
Dashboard_trials_count1 <- F_bigquery_sql_count_distinct(Dashboard_trials_table, Dashboard_trials_var1)
Dashboard_trials_count1 <- Dashboard_trials_count1$f0_
print(paste("DASHBOARD TABLE:", Dashboard_trials_table, "has", Dashboard_trials_count1,
            "distinct values for", Dashboard_trials_var1))

# Output dashboard data - from the SQL - Step 3 - Pubs
Dashboard_pubs_table_short <- str_split(Dashboard_pubs_table, "\\.")[[1]][3]
Dashboard_pubs_count1 <- F_bigquery_sql_count_distinct(Dashboard_pubs_table, Dashboard_pubs_var1)
Dashboard_pubs_count1 <- Dashboard_pubs_count1$f0_
print(paste("DASHBOARD TABLE:", Dashboard_pubs_table, "has", Dashboard_pubs_count1,
            "distinct values for", Dashboard_pubs_var1))

# Output dashboard data - from the SQL - Step 4 - ORCID for researchers
Dashboard_orcid_table_short <- str_split(Dashboard_orcid_table, "\\.")[[1]][3]
Dashboard_orcid_count1 <- F_bigquery_sql_count_distinct(Dashboard_orcid_table, Dashboard_orcid_var1)
Dashboard_orcid_count1 <- Dashboard_orcid_count1$f0_
print(paste("DASHBOARD TABLE:", Dashboard_orcid_table, "has", Dashboard_orcid_count1,
            "distinct values for", Dashboard_orcid_var1))

# Academic Observatory - this is the version of the Academic Observatory
AcademicObservatory_table_short <- str_split(AcademicObservatory_table, "\\.")[[1]][3]
AcademicObservatory_count1 <- F_bigquery_sql_count_distinct(AcademicObservatory_table, AcademicObservatory_var1)
AcademicObservatory_count1 <- AcademicObservatory_count1$f0_
print(paste("ACADEMIC OBSERVATORY:",AcademicObservatory_table, "has", 
            AcademicObservatory_count1,"distinct values for",AcademicObservatory_var1))
```



```{r graph_biomedical_main, fig.show='show', warning=TRUE, messages=TRUE}
#------------------------------------------------|
# Main
#------------------------------------------------|

graph_biomedical_main <- "digraph {
  # ---------------------------------------------------------
  # --- Set default attibutes
  # ---------------------------------------------------------
  layout = dot
  node [shape = rectangle, fixedsize=FALSE, height=0.01 width=0.4, 
      style='filled,rounded', fillcolor=transparent, penwidth=1.5
      fontname = Helvetica, fontsize=16, compound=TRUE]
  edge [color=black, arrowhead=normal, arrowsize=1.2, penwidth=2.5]

  # ---------------------------------------------------------
  # DATASETS: ACADEMIC OBSERVATORY
  # ---------------------------------------------------------
  # ------ SHAPES & LABELS - Academic Observatory
  DATA_AcademicObservatory[label = 'Academic Observatory \\n@@1 \\n@@2 DOIs',fillcolor='#ff671c']

  DATA_CrossrefMeta[label='Crossref \\nMetadata',fillcolor='#FFA376']
  DATA_CrossrefFunder[label='Crossref \\nFunder \\nRegistry',fillcolor='#FFA376']
  DATA_CrossrefEvents[label='Crossref \\nEvents',fillcolor=white]
  DATA_OpenAlex[label='Open \\nAlex',fillcolor='#FFA376']
  DATA_Unpaywall[label='Unpaywall',fillcolor='#FFA376']
  DATA_ROR[label= 'Research \\nOrganization \\nRegistry',fillcolor=white]
  DATA_OpenCit[label='Open \\nCitations',fillcolor=white]
  DATA_Pubmed[label='PubMed',fillcolor='#FFA376']
  
  # ---------------------------------------------------------
  # DATASETS: Contributed - RAW
  # ---------------------------------------------------------
  # ------ SHAPES & LABELS - Contributed DATA: pubs - RAW
  DATA_Contributed_pubs_raw[label = 'Target publication DOIs - raw \\n@@3',
      shape=oval, fillcolor='#2CCCD3']
      
  # ------ SHAPES & LABELS - Contributed DATA: Oddpub - RAW
  DATA_Contributed_Oddpub_raw[label = 'Oddpub output - Data and Software - raw \\n@@4',
      shape=ellipse, fillcolor='#2CCCD3']
      
  # ------ SHAPES & LABELS - trials - RAW
  DATA_Contributed_trials_raw[label = 'Clinical Trials - raw \\n@@5',
      shape=ellipse, fillcolor='#2CCCD3']

  # ------ SHAPES & LABELS - Contributed DATA: ORCID - RAW
  DATA_Contributed_orcid_raw[label = 'Researcher ORCIDs - raw \\n@@6',
      shape=ellipse, fillcolor='#2CCCD3']
      
  # ---------------------------------------------------------
  # DATASETS: Contributed - PROCESSED
  # ---------------------------------------------------------
  # ------ SHAPES & LABELS - Contributed DATA: pubs - PROCESSED
  DATA_Contributed_pubs[label = 'Target publication DOIs - imported \\n@@7 \\n@@8 unique [@@9]',
      shape=rectangle, fillcolor='#AAEAED']
      
  # ------ SHAPES & LABELS - Contributed DATA: Oddpubs - PROCESSED
  DATA_Contributed_Oddpub[label = 'Oddpub output- imported \\n@@10 \\n@@11 unique [@@12]',
      shape=rectangle, fillcolor='#AAEAED']

  # ------ SHAPES & LABELS - trials - PROCESSED
  DATA_Contributed_trials[label = 'Clinical Trials - imported \\n@@13 \\n@@14 unique [@@15]',
      shape=rectangle, fillcolor='#AAEAED']

  # ------ SHAPES & LABELS - Contributed DATA: ORCIDs - PROCESSED
  DATA_Contributed_orcid[label = 'Researcher ORCIDs - imported \\n@@16 \\n@@17 unique [@@18]',
      shape=rectangle, fillcolor='#AAEAED']
      
  # ---------------------------------------------------------
  # DATASETS: OUTPUT
  # ---------------------------------------------------------
  # ------ SHAPES & LABELS - Contributed DATA: pubs - OUTPUT
  OUTPUT_Dashboard_pubs[label = 'Dashboard data - Publications \\n@@19 \\n@@20 unique non-NULL [@@21]',
      shape=rectangle, fillcolor='#9DD8A1']
      
  # ------ SHAPES & LABELS - trials - OUTPUT
  OUTPUT_Dashboard_trials[label = 'Dashboard data - Clinical Trials \\n@@22 \\n@@23 unique non-NULL [@@24]',
      shape=rectangle, fillcolor='#9DD8A1']

  # ------ SHAPES & LABELS - Contributed DATA: ORCIDs - OUTPUT
  OUTPUT_Dashboard_orcid[label = 'Dashboard data - Researcher ORCIDs \\n@@25 \\n@@26 unique non-NULL [@@27]',
      shape=rectangle, fillcolor='#9DD8A1']
      
   # ------ SHAPES & LABELS - Dashboard
  OUTPUT_Dashboard[label = 'Dashboard', fontsize=24,
      shape=rectangle, fillcolor='#3BB143']
      
  # ---------------------------------------------------------
  # LINKS: ACADEMIC OBSERVATORY
  # ---------------------------------------------------------
 
  subgraph cluster_AcademicObservatory {
     style='filled, dashed';
     fillcolor='#FFF0E9';

     DATA_CrossrefMeta   -> DATA_AcademicObservatory
     DATA_CrossrefFunder -> DATA_AcademicObservatory 
     DATA_CrossrefEvents -> DATA_AcademicObservatory
     DATA_OpenAlex       -> DATA_AcademicObservatory
     DATA_Unpaywall      -> DATA_AcademicObservatory
     DATA_ROR            -> DATA_AcademicObservatory
     DATA_OpenCit        -> DATA_AcademicObservatory
     DATA_Pubmed         -> DATA_AcademicObservatory
  }
  
  # ---------------------------------------------------------
  # LINKS: CONTRIBUTED DATA - raw to processed
  # ---------------------------------------------------------
  DATA_Contributed_pubs_raw -> DATA_Contributed_pubs
  DATA_Contributed_Oddpub_raw -> DATA_Contributed_Oddpub
  DATA_Contributed_trials_raw -> DATA_Contributed_trials
  DATA_Contributed_orcid_raw -> DATA_Contributed_orcid
  
  # ---------------------------------------------------------
  # PROCESS #01 - From the AO, create meta list of clinical trial numbers
  # associated with DOIs
  # ---------------------------------------------------------

  Process_01[label = '
  SQL process #1 - Create meta-list of clinical trial numbers 
  associated with DOIs using Crossref & Pubmed fields and 
  abstract search', 
      shape=rectangle, style='filled, dashed', fillcolor=grey, fontsize=18]
  
  Output_Table_1[label = 'Intermediate Table \\n All Clinical Trial Numbers found for DOIs in Crossref & Pubmed']
    
  DATA_AcademicObservatory -> Process_01
  Process_01 -> Output_Table_1

  # ---------------------------------------------------------
  # PROCESS #02 - SQL to combine the contributed clinical trial data
  # with the meta list of clinical trial numbers
  # ---------------------------------------------------------
  Process_02[label = 'SQL process #2
    Match the contributed clinical trial data to 
    the meta list  of clinical trial numbers from 
    Pubmed and Crossref, and to the contributed DOIs', 
    shape=rectangle, style='filled, dashed', fillcolor=grey, fontsize=18]
  
  Output_Table_1 -> Process_02
  DATA_Contributed_trials -> Process_02
  DATA_Contributed_pubs -> Process_02
  Process_02 -> OUTPUT_Dashboard_trials
  OUTPUT_Dashboard_trials -> OUTPUT_Dashboard
    
  # ---------------------------------------------------------
  # PROCESS #03 - SQL to process the ORCID data for the dashbaord
  # ---------------------------------------------------------
  Process_03[label = 'SQL process #3
    Process the ORCID data', 
      shape=rectangle, style='filled, dashed', fillcolor=grey, fontsize=18]
  
  DATA_Contributed_orcid -> Process_03
  Process_03 -> OUTPUT_Dashboard_orcid
  OUTPUT_Dashboard_orcid -> OUTPUT_Dashboard
    
  # ---------------------------------------------------------
  # PROCESS #04 - SQL to process the Publication and Oddpub data for the dashboard
  # ---------------------------------------------------------
  Process_04[label = 'SQL process #4
    Process the Publication and Oddpub data', 
    fontsize=18, shape=rectangle, style='filled, dashed', fillcolor=grey]
  
  Output_Table_1 -> Process_04
  DATA_Contributed_pubs -> Process_04
  DATA_Contributed_Oddpub -> Process_04
  Process_04 -> OUTPUT_Dashboard_pubs
  OUTPUT_Dashboard_pubs -> OUTPUT_Dashboard
      
  # ---------------------------------------------------------
  # PROCESS #05 - Oddpub processing
  # ---------------------------------------------------------
  subgraph cluster_P05_Oddpub {
    style='filled, dashed';
    fillcolor='#E9FAFA';

    Process_05[label = 'Charite Oddpub processing', fontsize=18,
        shape=rectangle, style='filled, dashed', fillcolor=white]
    DATA_Contributed_pubs_raw -> Process_05
    DATA_Contributed_trials_raw -> Process_05
    Process_05 -> DATA_Contributed_Oddpub_raw
    }
  
  # ------ Add footnotes 
  }
  [1]:AcademicObservatory_table_short
  [2]:AcademicObservatory_count1
  [3]:Contributed_pubs_raw
  [4]:Contributed_Oddpub_raw
  [5]:Contributed_trials_raw
  [6]:Contributed_orcid_raw
  [7]:Contributed_pubs_table_short
  [8]:Contributed_pubs_count1
  [9]:Contributed_pubs_var1
  [10]:Contributed_Oddpub_table_short
  [11]:Contributed_Oddpub_count1
  [12]:Contributed_Oddpub_var1
  [13]:Contributed_trials_table_short
  [14]:Contributed_trials_count1
  [15]:Contributed_trials_var1
  [16]:Contributed_orcid_table_short
  [17]:Contributed_orcid_count1
  [18]:Contributed_orcid_var1
  [19]:Dashboard_pubs_table_short
  [20]:Dashboard_pubs_count1  
  [21]:Dashboard_pubs_var1
  [22]:Dashboard_trials_table_short
  [23]:Dashboard_trials_count1
  [24]:Dashboard_trials_var1
  [25]:Dashboard_orcid_table_short
  [26]:Dashboard_orcid_count1
  [27]:Dashboard_orcid_var1

  "
   
# Plot to graph to the screen / HTML
DiagrammeR::grViz(graph_biomedical_main)

# Export the graph as a PNG image file
F_export_grViz_graph2image(graph_biomedical_main)
#library(DiagrammeRsvg) #https://cran.r-project.org/web/packages/DiagrammeRsvg/index.html
#grViz(graph_biomedical_main) %>%
#    export_svg %>% charToRaw %>% rsvg_pdf("graph_biomedical_main")

# --------------------------------------
### HOW TO RANK rank=same {DATA_Contributed_Pubs, DATA_AcademicObservatory}
### HOW TO LABEL LINES DATA_AcademicObservatory -> P1_Combined_AO_and_Contributed[label = ' @@2 DOIs']
### HOW TO HAVE FOLDERS: data2 [label = 'Dataset 2', shape = folder, fillcolor = Beige]
### HOW TO Include a quote in a label, e.g.   \\' 
### HOW TO:   A cluster is a subgraph placed in its own distinct rectangle of the layout. A subgraph is recognized as a cluster ### when its name has the prefix cluster
### subgraph cluster_A {
### AAAA [label = 'Testing AAA']
### BBBB
#   https://graphviz.org/doc/info/shapes.html

```
